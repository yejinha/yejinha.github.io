---
layout: post
title: ì‹¤ìŠµ with spring boot  Netflix OSS ê³µê³µapi 1 - Hystrix fallback
date:  2020-02-28 15:34 
img: moomin.jpg # Add image post (optional)
categories: [msa]
tags: [MSA, Spring cloud, Netflix oss, zuul, IT] # add tag
sitemap :
changefreq : daily
priority : 1.0
---
í’€ì†ŒìŠ¤ëŠ” [ì—¬ê¸°](https://github.com/yaejinha/msa-SelfStudy) ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
ì•„ì£¼ ê¸°ë³¸ì ìœ¼ë¡œ ì§œì„œ ëŒì•„ëŠ” ê°€ëŠ”ê±¸ í™•ì¸í•˜ë ¤ê³  í•œë‹¤. 
ì²«ë²ˆì§¸ë¡œëŠ” ê°€ì¥ ê°„ë‹¨í•´ë³´ì´ëŠ”  **íŠ¹ì • ìš”ì²­ ì‹¤íŒ¨ì‹œ fallback ë©”ì†Œë“œ ì‹¤í–‰**ì´ë‹¤. 

ì •ë§ ê°„ë‹¨í•˜ê²Œ í•´ë³´ê³ ì ë‚˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ , ì„œë¹„ìŠ¤ í•˜ë‚˜ì”©ë§Œ ë§Œë“¤ê³  ê³µê³µ api ì‚¬ìš©í•´ì„œ ì •ìƒ ì‘ë‹µì¼ë•Œ/ fallback ì¼ë•Œë¥¼ ë³´ì—¬ì£¼ê¸°ë¡œ í–ˆë‹¤ :) 

**ì‚¬ìš©í•œ ê³µê³µ api**  
- ë…¸ì„ ì •ë³´ì¡°íšŒ ì„œë¹„ìŠ¤   
- ìš”ì²­ ë°ì´í„° : ë…¸ì„  ë²ˆí˜¸  
- ì‘ë‹µ ë°ì´í„° : ì‹œ/ì¢…ì , ì²«ì°¨ ì‹œê°„, ë§‰ì°¨ ì‹œê°„, ë…¸ì„  id ë“±  (xml í˜•ì‹)

ì¼ë‹¨ì€ get ìœ¼ë¡œ ìš”ì²­ ë“¤ì–´ì˜¤ë©´ ê³µê³µ api ì‚¬ìš©í•´ì„œ í•´ë‹¹ ë…¸ì„ ì˜ ë§‰ì°¨ì‹œê°„ì„ í‘œê¸°í•˜ë„ë¡ í•œë‹¤.   
ë…¸ì„  ë²ˆí˜¸ëŠ” ì…ë ¥ë°›ê³  ì‹¶ì—ˆëŠ”ë° ê·€ì°®ì•„ì„œ ê·¸ëƒ¥ ë‚´ê°€ ìì£¼ íƒ€ëŠ” 153ë²ˆìœ¼ë¡œ ê³ ì •í–ˆë‹¤.   
êµ¬ì¡°ëŠ” ê°„ë‹¨í•˜ë‹¤.   

![ê¸°ë³¸êµ¬ì¡°](/assets/img/2020-02-28-hystrix-1/simpleArchitecture.png)

ê·¸ë¦¬ê³  êµ¬í˜„ë„ ê·¸ëƒ¥ resttemplate í†µí•´ì„œ ê°„ë‹¨í•˜ê²Œ ë§Œë“¤ì—ˆë‹¤.  
ë‚˜ì¤‘ì— ì¬í™œìš©í•´ì„œ  í™•ì¥í•´ë³´ë ¤ê³   resttemplate ì€ íŒ©í† ë¦¬ë¡œ ë§Œë“¤ì–´ì„œ ì£¼ì…í•´ì„œ ì“°ê³ , DAOë¡œ busInfo ë¼ëŠ” í´ë˜ìŠ¤ ë§Œë“¤ì—ˆë‹¤.  

ì—¬ê¸°ê¹Œì§€ëŠ”  ìŠ¤í”„ë§ ê¸°ì´ˆë¥¼ ê°€ì§€ê³  ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.   
ì´ ìƒíƒœì—ì„œë„  ë§Œì•½ ê³µê³µ api ì‘ë‹µ ë°›ì•„ì˜¬ë•Œ ì—ëŸ¬ê°€ ë‚œë‹¤ë©´ try catch ë¡œ ë§‰ì„ ìˆ˜ëŠ” ìˆë‹¤.  

```java
	public String askIsOver() throws Exception {
		
		String baseUrl = "http://ws.bus.go.k2r/api/rest/busRouteInfo/getBusRouteList";
		
		String serviceKey = URLDecoder.decode("api ì¸ì¦í‚¤ ìë¦¬", "UTF-8"); // ì´ê±° ì•ˆí•´ì£¼ë©´  ì¸ì¦ ì—ëŸ¬ ë‚¨. í•œë²ˆ ë” ì¸ì½”ë”© í•˜ë©´ì„œ ì¸ì¦í‚¤ê°€ ì œëŒ€ë¡œ ì „ë‹¬ì•ˆë¨.   
		   
        UriComponents uri = UriComponentsBuilder.fromHttpUrl(baseUrl+"?"+"serviceKey="+serviceKey+"&strSrch=153").build();
		
		RestTemplate restTemplate = rest.restTemplate();
		
	    try {
		String apiResult = restTemplate.getForObject(uri.toString(), String.class);
        
        //ì‘ë‹µì´ xml ë¡œ ì™€ì„œ ì˜ë¼ì„œ DAOì¸ busInfo ì— ë„£ëŠ”ë‹¤. 
	    DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();
	    DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();
	    Document doc = dBuilder.parse(new InputSource(new StringReader(apiResult)));
	    doc.getDocumentElement().normalize();
	    Node firstResult = doc.getElementsByTagName("itemList").item(0);	
	    // ì¼ë‹¨ì€  ë§‰ì°¨ì‹œê°„ ì •ë³´ë§Œ ë½‘ì•„ì„œ ì €ì¥ 
	    for (int temp = 0; temp < firstResult.getChildNodes().getLength(); temp++) {
	    	String nodeName =firstResult.getChildNodes().item(temp).getNodeName();
	    	if(nodeName.equals("lastBusTm")) {
	    		busInfo.setLastBusTm(firstResult.getChildNodes().item(temp).getTextContent());
	    	}
	    		
	    }        
	         
		return busInfo.getLastBusTm();  //ì •ìƒì´ë©´ ë§‰ì°¨ì‹œê°„ ë¦¬í„´
		
	    }catch(Exception e) {
	    	e.printStackTrace();
	    }finally {
	    	return "íŠ¸ë¼ì´ ìºì¹˜ì…ë‹ˆë‹¤";  // try catch finally ë¡œ ì—ëŸ¬ ë§‰ìŒ
	    }
		
	}
```


í•˜ì§€ë§Œ  ì—¬ê¸°ì„œëŠ” hystrix ì‚¬ìš©í•´ ê°„ë‹¨í•˜ê²Œ fallback ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•´ë²„ë¦¬ê² ë‹¤.    
hystrix ì‚¬ìš©í•˜ê²Œ ìœ„í•´ì„œëŠ”  ì„¸ê°€ì§€ ë‹¨ê³„ê°€ í•„ìš”í•˜ë‹¤.  

1) pom.xml ì— ì˜ì¡´ì„± ì •ì˜í•´ì¤˜ì„œ ë©”ì´ë¸ì´ ì½ì–´ì˜¤ê²Œ í•˜ê¸° !  

```xml
	<dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-netflix-hystrix</artifactId>
   </dependency>
```

2) <span style="color:#827DE4">@EnableHystrix </span>ì–´ë…¸í…Œì´ì…˜ ë¶™ì—¬ì£¼ê¸°  

 ì´ê±´ ë©”ì¸ ë©”ì†Œë“œê°€ ìˆëŠ” ìœ„ì¹˜ì—ì„œ  ì–´ë…¸í…Œì´ì…˜ ë¶™ì—¬ì¤˜ë„ ë˜ê³ ,  ì§€ê¸ˆì€  circuit ê°™ì€  ë„“ì€ ë‹¨ìœ„ ë´ì•¼í•˜ëŠ” ê±° ì•ˆì“°ê³  fallback ë§Œ í•´ë³¼ê±°ë‹ˆê¹Œ í•´ë‹¹ ë©”ì†Œë“œê°€ ìˆëŠ” ì„œë¹„ìŠ¤ì—ë‹¤ê°€ë§Œ ë¶™ì—¬ì¤˜ë„ ì •ìƒ ë™ì‘í•œë‹¤.  
 ë‚˜ì¤‘ì— circuit openê¹Œì§€ í•´ë³¼êº¼ë‹ˆê°€ ë©”ì¸ ë©”ì†Œë“œ ìˆëŠ”ë°ì— ë¶™ì—¬ì¤€ë‹¤.  

 ```java
 @EnableHystrix   // ì—¬ê¸° ì´ ì–´ë…¸í…Œì´ì…˜ ! 
@SpringBootApplication
public class SnoopyApplication {

	public static void main(String[] args) {
		SpringApplication.run(SnoopyApplication.class, args);
	}

}
```

3) <span style="color:#827DE4">@HystrixCommand(fallbackMethod = "fallbackë©”ì†Œë“œ ì´ë¦„")</span> ë¡œ fallback ë©”ì†Œë“œ ì‹¤í–‰í•  ìœ„ì¹˜ ì •í•˜ê³ , ë©”ì†Œë“œ ë‚´ìš© ì •ì˜í•˜ê¸°  

  ```java
  @HystrixCommand(fallbackMethod = "fallback") // fallback ì¼ ê²½ìš° fallbackì´ë€ ì´ë¦„ì˜ ë©”ì†Œë“œ ì‹¤í–‰
  public String askIsOver() throws Exception { 
    ...
  }
 
 public String fallback() {
		return  "ë…¸ì„  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
}
```

ì´ë ‡ê²Œ í•˜ë©´ ì¼ë¶€ëŸ¬ urlì„ ì˜ëª» ë„£ì—ˆì„ ë•Œì—ë„ fallback ë©”ì†Œë“œ ë°”ë¡œ ì‹¤í–‰ëœë‹¤ :)  

ê·¼ë° ì´ë ‡ê²Œ ì‹¤ìŠµì„ í•˜ë‚˜ í•´ë³´ë‹ˆê¹Œ ê¶ê¸ˆí•œ ì ì´ ìˆë‹¤. 

## **try catch ì™€ fallback ë©”ì†Œë“œì˜ ì°¨ì´ì **  

try catch ë¥¼ í•˜ëŠ” ê²½ìš° exception ë°œìƒí•˜ë©´ ë©”ì‹œì§€ë¥¼ ì°ì–´ë³´ë‹ˆê¹Œ ì½˜ì†”ë¡œê·¸ë¡œ ì™œ ì—ëŸ¬ê°€ ë‚¬ëŠ”ì§€ íŒŒì•…í•˜ê¸°ê°€ ì‰½ë‹¤.  
ë°˜ë©´ì— fallback ë©”ì†Œë“œë¡œ ë¹ ì§€ëŠ” ê²½ìš°  ì—ëŸ¬ë¡œê·¸ê°€ ë‚¨ì§€ ì•Šê¸° ë•Œë¬¸ì—  ë¬´ì—‡ë•Œë¬¸ì— ë‚œ ì—ëŸ¬ì¸ì§€ ì°¾ê¸°ê°€ ì–´ë µë‹¤.  
stackvoerflow ë¥¼ ì¢€ ì°¾ì•„ë³´ë‹ˆ ê°™ì€ ë¬¸ì œë¡œ ê³ ë¯¼í•˜ëŠ” ì‚¬ëŒë“¤ì´ ìˆì—ˆë‹¤.  [ë§í¬](https://stackoverflow.com/questions/32830654/get-failure-exception-in-hystrixcommand-fallback-method)  
ë§í¬ì—ì„œ ì²˜ëŸ¼ throwable ì¸ìë¥¼ ì¶”ê°€í•´ì„œ ì—ëŸ¬ ë¡œê·¸ í™•ì¸í•´ë³´ì•˜ë‹¤.  
### ğŸ˜‹ğŸ˜‹ğŸ˜‹ <span style="color:#ED6666">ì—ëŸ¬ ì¶”ì ì„ ì‰½ê²Œí•˜ê¸° ìœ„í•´ì„œëŠ” fallback ë©”ì„œë“œì— throwable ì¸ìë¥¼ ì¶”ê°€í•˜ì ^^ !! </span>

![ì—ëŸ¬ë¡œê·¸](/assets/img/2020-02-28-hystrix-1/errorlogbyfallback.png)

```java
public String fallback(Throwable e) {
		e.printStackTrace();
		return  "ë…¸ì„  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
}
```

fallback ì‹¤ìŠµ ë !!  ë‹¤ìŒì€ circuit open ì‹¤ìŠµ í•´ë³´ê² ìŠµë‹ˆë‹¤~~  





